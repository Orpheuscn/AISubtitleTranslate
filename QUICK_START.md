# 快速开始 - 测试提示词改进

## 改进内容概述

我们对字幕翻译的提示词进行了重大改进，主要解决 AI 将多条字幕合并成一条的问题。

**核心改进：**
- ✅ 重新定义任务性质：从"翻译任务"改为"格式化输出任务"
- ✅ 明确思考方式：为每个序号槽位填入翻译，而不是先翻译再分配
- ✅ 强化验证步骤：要求 AI 在输出前检查序号数量
- ✅ 增强错误检测：详细报告缺失/多余的序号

## 如何测试

### 步骤 1：启动应用

```bash
npm run dev
```

### 步骤 2：加载字幕文件

在应用中加载你的 SRT 字幕文件（建议使用包含 829-830 序号的文件）。

### 步骤 3：配置 API

确保已配置 DeepSeek API 密钥。

### 步骤 4：开始翻译

点击"开始翻译"按钮，观察控制台输出。

### 步骤 5：检查结果

**在控制台中查看：**

1. **批次信息：**
   ```
   🔍 批次信息:
      前置上下文: X 条
      需要翻译: Y 条
      后置上下文: Z 条
   ```

2. **API 请求和响应：**
   ```
   📤 发送请求到 DeepSeek API...
   📥 收到 API 响应
   ```

3. **解析结果：**
   ```
   ✅ 解析完成，共提取 N 条翻译
      期望数量: N
   ```

4. **如果出现错误：**
   ```
   🚨 严重错误：翻译数量不匹配！
   期望翻译 N 条字幕，但实际收到 M 条
   
   ❌ 缺失的序号: [...]
   ➕ 多余的序号: [...]
   
   💡 可能的原因：
      1. AI 将多条字幕合并成了一条（最常见）
      2. AI 跳过了某些序号
      3. AI 添加了不存在的序号
   ```

## 成功标准

翻译成功的标志：

- ✅ 控制台显示"解析完成，共提取 N 条翻译"
- ✅ "期望数量"和"实际获得"数量一致
- ✅ 没有"翻译数量不匹配"的错误
- ✅ 翻译结果语义正确，保持上下文延续

## 常见问题

### Q1: 仍然出现"翻译数量不匹配"错误怎么办？

**A:** 查看控制台中的完整 API 响应，分析 AI 的实际输出模式：

1. 如果 AI 仍然合并序号 → 可能需要进一步强化提示词
2. 如果 AI 跳过某些序号 → 检查是否是特殊字符或格式问题
3. 如果 AI 添加多余序号 → 检查是否误解了 [CONTEXT] 标记

### Q2: 翻译质量下降了怎么办？

**A:** 这些改进主要针对序号匹配问题，不应该影响翻译质量。如果发现质量下降：

1. 检查是否是因为强制分割导致的不自然
2. 可以在保持序号数量的前提下，调整翻译内容的分配
3. 确保上下文标记正确，AI 能理解句子的延续关系

### Q3: 如何查看完整的提示词？

**A:** 控制台会打印完整的 System 消息和 User 消息：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 System 消息（完整）:
[完整的系统提示词]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📨 User 消息（完整）:
[完整的用户消息]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 测试用例

### 测试用例 1：两条字幕（829-830）

**期望：** 输出 2 条翻译，序号为 [829, 830]

### 测试用例 2：三条地名列表（763-765）

**期望：** 输出 3 条翻译，序号为 [763, 764, 765]

### 测试用例 3：带上下文的延续（96-99）

**期望：** 输出 2 条翻译，序号为 [98, 99]（不包括 [96, 97] 的 CONTEXT）

详细测试用例请参考 `test-cases.md`。

## 进一步改进

如果测试后发现问题仍然存在，可以考虑：

1. **调整批次大小**：减小每批次的字幕数量，降低 AI 出错的概率
2. **使用更强的模型**：尝试 GPT-4 或其他更强的模型
3. **结构化输出**：使用 JSON 格式强制序号对应
4. **自动重试**：检测到错误后自动重试

详细改进方案请参考 `PROMPT_IMPROVEMENTS.md`。

## 反馈

如果你发现任何问题或有改进建议，请：

1. 保存控制台的完整输出
2. 记录出现问题的序号范围
3. 提供 API 的完整响应
4. 描述期望的行为和实际的行为

这些信息将帮助我们进一步优化提示词。

