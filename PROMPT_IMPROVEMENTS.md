# 字幕翻译提示词改进方案

## 问题诊断

### 核心问题
AI 经常将多条字幕合并成一条，导致序号数量不匹配。例如：

**输入（2 个序号）：**
```
[829] speaks of that suffering woman who can find no rest
[830] and who tosses in her bed due to the pain that torments her,
```

**错误输出（合并成 1 个序号）：**
```
[829] 说起那个无法安眠、痛苦辗转的女人时，
```

**正确输出（保持 2 个序号）：**
```
[829] 说起那个无法安眠、
[830] 痛苦辗转的女人时，
```

### 根本原因
AI 将这当成了"翻译任务"，思考流程是：
1. 理解整体语义 → "说起那个无法安眠、痛苦辗转的女人时"
2. 翻译成流畅的中文句子
3. 尝试分配到序号中 → 发现是一个完整句子 → 放到一个序号里

## 解决方案

### 策略 1：任务重新定义

**核心思想转变：**
- ❌ 旧思路：这是翻译任务
- ✅ 新思路：这是格式化输出任务

**具体实现：**
在提示词开头明确声明：
```
🚨 这不是普通翻译任务，这是格式化输出任务！🚨

你的任务是：将每个序号的内容翻译后，填入对应的序号槽位中。

核心约束（违反即为失败）：
- 输入有 N 个序号 → 输出必须有 N 个序号
- 每个序号只能出现一次，且必须出现
- 序号必须与输入完全一致
```

### 策略 2：思考方式引导

明确告诉 AI 正确和错误的思考方式：

```
思考方式：
❌ 错误：先翻译成流畅的句子，再分配到序号中（会导致序号数量不匹配）
✅ 正确：为每个序号单独翻译，即使翻译结果不完整也必须保持序号对应
```

### 策略 3：原因说明

解释为什么必须保持序号对应：

```
为什么必须这样？
因为字幕需要与视频时间轴精确对应。每个序号对应特定的时间段。
如果合并序号，时间轴就会错乱，字幕无法正常显示。
```

### 策略 4：具体示例强化

使用用户提供的真实案例作为示例：

```
示例说明：

输入（2 个序号）：
[829] speaks of that suffering woman who can find no rest
[830] and who tosses in her bed due to the pain that torments her,

❌ 错误输出（合并成 1 个序号）：
[829] 说起那个无法安眠、痛苦辗转的女人时，

✅ 正确输出（保持 2 个序号）：
[829] 说起那个无法安眠、
[830] 痛苦辗转的女人时，
```

### 策略 5：验证步骤明确化

要求 AI 在输出前执行验证：

```
输出前必须验证：
1. 数一数输入中有多少个需要翻译的序号（不包括 [CONTEXT]）= N 个
2. 数一数你的输出中有多少个序号
3. 检查两个数字是否完全相等
4. 检查输出中的序号是否与输入中的序号完全一致

如果任何一步检查失败，说明你的翻译有问题，必须重新调整。
```

### 策略 6：错误检测增强

在代码层面增强错误检测和报告：

```typescript
// 详细报告缺失/多余的序号
if (translationMap.size !== batch.length) {
  console.error(`🚨 严重错误：翻译数量不匹配！`)
  console.error(`期望翻译 ${batch.length} 条字幕，但实际收到 ${translationMap.size} 条`)
  
  // 显示缺失的序号及其原文
  // 显示多余的序号
  // 显示完整的 API 响应
  // 分析可能的错误原因
}
```

## 改进效果预期

1. **减少合并错误**：通过明确任务性质，减少 AI 合并序号的倾向
2. **提高准确性**：通过验证步骤，让 AI 自我检查输出
3. **更好的调试**：通过详细的错误报告，快速定位问题
4. **保持语义连贯**：同时保持对上下文的理解和延续关系的处理

## 测试建议

1. 使用包含 829-830 的批次进行测试
2. 观察控制台输出，检查是否还有"翻译数量不匹配"的错误
3. 如果仍有问题，查看完整的 API 响应，分析 AI 的实际输出
4. 根据实际情况进一步调整提示词

## 可能的进一步改进

如果问题仍然存在，可以考虑：

1. **Few-shot 学习**：在系统提示词中加入更多正确/错误示例对
2. **Chain-of-Thought**：要求 AI 先列出序号清单，再逐个翻译
3. **结构化输出**：使用 JSON 格式强制序号对应
4. **自动重试**：如果检测到数量不匹配，自动重试该批次
5. **模型切换**：尝试使用更强的模型（如 GPT-4）

