# 字幕翻译提示词改进 - 变更总结

## 改进日期
2025-12-24

## 问题描述
AI 经常将多条字幕合并成一条，导致序号数量不匹配。例如将 2 条字幕合并成 1 条，导致翻译结果缺少序号。

## 核心改进

### 1. 任务重新定义

**位置：** `src/composables/useSubtitleTranslation.ts`

**改进内容：**
- 在系统提示词和用户消息中明确声明：这是"格式化输出任务"，不是普通翻译任务
- 强调：输入 N 个序号 → 输出必须 N 个序号
- 解释原因：字幕需要与视频时间轴精确对应

**关键语句：**
```
🚨 这不是普通翻译任务，这是格式化输出任务！🚨

你的任务是：将每个序号的内容翻译后，填入对应的序号槽位中。

记住：这不是翻译任务，这是格式化输出任务！
你的目标是：为每个序号槽位填入翻译内容，而不是翻译成流畅的句子后再分配序号。
```

### 2. 思考方式引导

**改进内容：**
- 明确告诉 AI 正确和错误的思考方式
- 使用对比示例说明

**关键语句：**
```
思考方式：
❌ 错误：先翻译成流畅的句子，再分配到序号中（会导致序号数量不匹配）
✅ 正确：为每个序号单独翻译，即使翻译结果不完整也必须保持序号对应
```

### 3. 具体示例强化

**改进内容：**
- 使用用户提供的真实案例（829-830）作为示例
- 展示正确和错误的对比
- 在系统提示词中添加多个示例

**示例：**
```
输入（2 个序号）：
[829] speaks of that suffering woman who can find no rest
[830] and who tosses in her bed due to the pain that torments her,

❌ 错误输出（合并成 1 个序号）：
[829] 说起那个无法安眠、痛苦辗转的女人时，

✅ 正确输出（保持 2 个序号）：
[829] 说起那个无法安眠、
[830] 痛苦辗转的女人时，
```

### 4. 验证步骤明确化

**改进内容：**
- 要求 AI 在输出前执行 4 步验证
- 在系统提示词和用户消息中都强调验证步骤

**验证步骤：**
```
输出前必须验证：
1. 数一数输入中有多少个需要翻译的序号（不包括 [CONTEXT]）
2. 数一数你的输出中有多少个序号
3. 检查两个数字是否完全相等
4. 检查输出中的序号是否与输入中的序号完全一致

如果任何一步检查失败，说明你的翻译有问题，必须重新调整。
```

### 5. 错误检测增强

**改进内容：**
- 在解析响应后，详细报告缺失/多余的序号
- 显示完整的 API 响应用于调试
- 分析可能的错误原因

**代码改进：**
```typescript
if (translationMap.size !== batch.length) {
  console.error(`🚨 严重错误：翻译数量不匹配！`)
  console.error(`期望翻译 ${batch.length} 条字幕，但实际收到 ${translationMap.size} 条`)
  
  // 显示缺失的序号及其原文
  if (missingIndices.length > 0) {
    console.error(`❌ 缺失的序号 (${missingIndices.length} 个): [${missingIndices.join(', ')}]`)
    // ...
  }
  
  // 显示多余的序号
  if (extraIndices.length > 0) {
    console.error(`➕ 多余的序号 (${extraIndices.length} 个): [${extraIndices.join(', ')}]`)
    // ...
  }
  
  // 显示可能的原因
  console.error(`💡 可能的原因：`)
  console.error(`   1. AI 将多条字幕合并成了一条（最常见）`)
  console.error(`   2. AI 跳过了某些序号`)
  console.error(`   3. AI 添加了不存在的序号`)
}
```

## 文件变更

### 修改的文件
- `src/composables/useSubtitleTranslation.ts`
  - 更新系统提示词（第 130-315 行）
  - 更新用户消息（第 421-467 行）
  - 增强错误检测（第 525-571 行）

### 新增的文件
- `PROMPT_IMPROVEMENTS.md` - 改进方案详细说明
- `test-cases.md` - 测试用例
- `test-prompt-improvement.md` - 测试计划
- `CHANGES_SUMMARY.md` - 本文件

## 测试建议

1. 使用包含 829-830 序号的批次进行测试
2. 观察控制台输出，检查是否还有"翻译数量不匹配"的错误
3. 如果仍有问题，查看完整的 API 响应，分析 AI 的实际输出
4. 根据实际情况进一步调整提示词

## 预期效果

- ✅ 减少序号合并错误
- ✅ 提高序号数量匹配的准确性
- ✅ 保持翻译的语义连贯性
- ✅ 更好的错误诊断和调试能力

## 可能的进一步改进

如果问题仍然存在，可以考虑：

1. **Few-shot 学习**：在系统提示词中加入更多正确/错误示例对
2. **Chain-of-Thought**：要求 AI 先列出序号清单，再逐个翻译
3. **结构化输出**：使用 JSON 格式强制序号对应
4. **自动重试**：如果检测到数量不匹配，自动重试该批次
5. **模型切换**：尝试使用更强的模型（如 GPT-4）

## 注意事项

- 这些改进主要针对"序号合并"问题
- 仍然保持了对上下文理解和延续关系的处理
- 没有改变翻译质量要求和专有名词处理逻辑

